---
layout:     post
title:      "JVM - 方法区"
subtitle:   " \"JVM Daily Notes - 14\""
date:       2021.01.12 12:29:00
author:     "Wuy"
header-img: "img/post-bg-2020.jpg"
catalog: true
tags:
    - 学习笔记
    - 读书
    - JVM


---

> *"Keep Learning JVM"*

# 方法区

- 方法区可以看作是一块独立于Java堆的内存空间；
- 方法区与Java堆一样，是各个线程共享的内存区域；
- 方法区在JVM启动的时候创建，并且它的实际的物理内存空间中和Java堆区一样都可以是不连续的；
- 方法区的大小，和堆空间一样，可以选择固定大小或者可扩展；
- 方法区的大小决定了系统可以保存多少个类，如果系统定义了太多类，导致方法区溢出，虚拟机同样会抛出内存溢出错误；
- 关闭JVM就会释放这个区域的内存；
- 仅对HotSpot而言，方法区等价于永久代，元空间的话，不在虚拟机设置的内存中，而是使用本地内存；

## 设置方法区大小与OOM

- JDK 7 及之前：
  - 通过`-XX:PermSize`来设置永久代初始分配空间。默认值是20.75M；
  - `-XX:MaxPermSize`来设置永久代最大可分配空间。32位机器默认是64M，64位机器默认是82M；
  - 当JVM加载的类信息容量超过了这个值。会报异常`OutOfMemoryError:PermGenspace`
- JDK 8 及之后：
  - 上述指令变为`-XX:MetaspaceSize`， 默认21M（64位机器）， 和`-XX:MaxMetaspaceSize`， 默认-1，就是没有限制;
  - 上述的21M是一个初始水位线，当超过它之后，会触发`Full GC`，如果释放空间后仍然不足，则在不超过最大值的情况下会自动适当提高水位线，如果释放太多空间，则适当降低，所以尽量将这个初始值调大一些。
- 如何解决`OOM`：
  - 如果是内存泄漏，可以先通过内存映像分析工具对dump出来的存储快照进行分析，进一步使用工具查看泄漏对象到`GC Root`的引用链。于是就可以找到泄露对象是通过怎样的路径与之关联导致垃圾回收器无法自动回收它们的；
  - 如果不存在内存泄漏，就需要检查虚拟机的堆参数与物理内存比较看是否还可以调大。从代码上检查是否存在某些对象生命周期过长、持有时间过长的情况；

## 方法区的内存结构

- 方法区存储已被虚拟机加载的类型信息（包括域信息、方法信息等）、常量、静态变量、即时编译器编译后的代码缓存等；
  - 类型信息（类、接口、枚举、注解）：
    - 这个类型的完整有效名称；
    - 这个类型的直接父类的完整有效名(接口和`Object`类)是没有父类的；
    - 这个类型的修饰符(`public`,`abstract`,`final`的某个子集)；
    - 这个类型直接接口的一个有效列表；
  - 域信息：
    - 域名称；
    - 域类型；
    - 域修饰符；
  - 方法信息：
    - 方法名称；
    - 方法的返回类型；
    - 方法的参数的数量和类型（按顺序）；
    - 方法的修饰符；
    - 方法的字节码、操作数栈、局部变量表及其大小（`abstract`和`native`方法除外）；
    - 异常表（`abstract`和`native`方法除外）
- `non-final`的类变量
  - 静态变量和类关联在一起，随着类的加载而加载，他们成为类数据在逻辑上的一部分；
  - 类变量被类的所有实例共享，即使没有类实例时你也可以访问它；
- 全局常量（`static final`）
  - 编译阶段就直接赋值

## 常量池

- 方法区，内部包含了运行时常量池；
- 字节码文件，内部包含了常量池（包含了各种字面量和对类型、域和方法的符号引用）；
- 为什么需要常量池？
  - Java中的字节码文件需要数据支持，如果都加载进去，内存消耗过大，因此可以存储到常量池中，字节码文件中则存储了指向常量池的符号引用；
- 常量池包含：
  - 数量值；
  - 字符串值；
  - 类应用；
  - 字段引用；
  - 方法引用

## 运行时常量池

- 是方法区的一部分；

- 常量池表是类文件的一部分，用于存放编译器生成的各种字面量与符号引用，这部分内容将在类加载后存放到方法区的运行时常量池中；

- 在加载类和接口到虚拟机中后，就会创建对应的运行时常量池；

- JVM为每个已加载的类型（类或者接口）都维护一个常量池。池中的数据项就像数组项一样，是通过索引访问的；

- 运行时常量池中包含多种不同的常量，包括编译期就已经明确的数值字面量，也包括运行期解析后才能够获得的方法或者字段引用，此时已经不再是常量池中的符号地址了，这里转换为字符地址；

  - 相比于常量池，另一个重要特征就是动态性（`String.intern()`）；

- 如果构造运行时常量池所需的内存空间超过了方法区提供的最大值，JVM也会报OOM异常；

  





























