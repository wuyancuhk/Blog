---
layout:     post
title:      "JVM - Daily Notes - 06"
subtitle:   " \"JAVA Knowledge - JVM\""
date:       2020.12.31 12:29:00
author:     "Wuy"
header-img: "img/post-bg-2020.jpg"
catalog: true
tags:
    - 学习笔记
    - 读书
    - JVM

---

> *"Keep Learning JVM"*

# 虚拟机栈

## 出现背景

由于跨平台的设计，Java的指令都是根据栈来设计的，由于不同平台的CPU架构不同，所以不能设计为基于寄存器的。
优点是跨平台，指令集较小，编译器容易实现，缺点是性能下降，实现同样的功能需要更多的指令。

## 内存中的栈和堆

栈是运行时的单位，而堆是存储的单位。

## 基本概念

每个线程在创建时都会创建一个虚拟机栈，其内部保存一个个的栈帧，它也是线程私有的，生命周期和线程保持一致，作用是主管Java程序的运行，它保存方法的局部变量（8种基本数据类型和对象的引用地址）和部分结果，并参与方法的调用和返回。一个栈帧就对应一个方法。

优点：
- 栈是一种快速有效的分配存储方式，访问速度仅次于程序计数器；
- 每个方法执行，伴随着出栈和入栈，以及执行结束后的出栈；
- 对于栈来说不存在垃圾回收问题，但是存在OOM问题；

## 开发中常见的异常

虚拟机规范允许Java栈的大小是动态的或者是固定不变的，对于第一种，可能会遇到`StackOverflowError`，对于第二种，可能遇到`OutOfMemoryError`异常。

## 如何设置栈的大小

利用指令 `-Xss size`设置线程的最大栈空间大小。

## 栈的存储单位

- 每个线程都有自己的栈，栈中的数据都是以栈帧的格式存在的；
- 在这个线程上正在执行的每个方法都各自对应一个栈帧；
- 栈帧是一个内存区块，是一个数据集，维系着方法执行过程中的各种数据信息。

## 栈运行原理

- JVM直接堆Java栈的操作只有两个，就是堆栈帧的压栈和出栈；
- 在一个活动线程中，一个时间点上，只有一个活动的栈帧。即只有当前正在执行的方法的栈帧是有效的，这恶栈帧也称作当前栈帧，与之对应的方法也就叫做当前方法，定义这个方法的类就叫做当前类；
- 执行引擎中的字节码指令之对于当前栈帧有效；
- 如果该方法中调用了其他方法，对应的新的栈帧也就会创建出来，放在栈顶，称为新的当前栈帧。

- 不同的线程中所包含的栈帧是不允许相互引用的，即不可能在一个栈帧中引用另外一个线程的栈帧；
- 如果当前方法调用了其他方法，方法返回之际，当前栈帧会把执行结果传给前一个栈帧，接着，虚拟机会丢弃当前栈帧，是的前一个栈帧成为当前栈帧；
- Java有两种返回方式，一个是`return`，一个是抛出未捕获且未处理的异常，两种情况都会导致栈帧被弹出。