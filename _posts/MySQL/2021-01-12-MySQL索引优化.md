---
layout:     post
title:      "MySQL - 索引优化"
subtitle:   " \"MySQL Knowledge - 高级部分\""
date:       2021.01.12 12:29:00
author:     "Wuy"
header-img: "img/post-bg-2020.jpg"
catalog: true
tags:
    - 学习笔记
    - 读书
    - MySQL



---

> *"Keep Learning MySQL"*

# 索引优化

1. 单表索引

   这里的关键点在于复合索引中的后一个索引能否根据前一个索引检索到，如果不可以，执行`explain`则会发现`Extra`字段里出现了`using filesort`，这是需要避免的；

2. 双表索引

   `left join`的话，需要对右表建索引，`right join`则相反，因为被连接的那个表一定是有缺失值的。
   
3. 多表索引

   索引最好设置在需要经常查询的字段中（也就是左连接和右连接常用的字段）。

4. 几条原则：

   - 尽可能减少`join`语句中的循环总次数（小结果集驱动大结果集）；
   - 优先优化内层循环；
   - 保证`join`语句中被驱动表上的`join`条件字段已被索引；
   - 在建索引的前提下，不要吝啬`joinbuffer`的设置。

## 索引失效

1. 全值匹配最优；
2. 最左匹配原则（依此匹配，不能断层）；
3. 不在索引列上做任何的操作（计算、函数、（自动或手动）类型转换），会导致索引失效而转向全表扫描；
4. 存储引擎无法做到使用索引中范围条件右边的索引列；
5. 尽量使用覆盖索引（只访问左营的查询（索引列和查询列一致）），减少`select *`;
6. MySQL使用不等于（`!=/<>`）的时候无法使用索引会导致全表扫描;
7. `is null`和`is not null`也无法使用索引；
8. `like`以通配符开头（‘`%abc...`’），MySQL索引失效会编程全表扫描的操作，最好把百分号放在右边；
   - 通配符放右边相当于范围查找，与范围条件不太一样，它不会导致下一个索引失效；
   - 对于双端都有通配符的情况，使用覆盖索引就可以解决。
9. 字符串不加单引号索引失效；
10. 少用`or`，用它来连接时会索引失效。

## 常见索引面试题

1. 最好索引怎么建就怎么用，尽管通过优化器可以优化查询语句，保证查询的字段的顺序优化后和索引保持一致；

2. 范围条件之后索引全失效；

3. 索引的作用是查找和排序，如果只用于排序，那么不会计入`key_len`；

4. `group by`之前必会先排序，会有临时表产生。

5. 一般建议：

   - 对于单键索引，尽量选择针对当前`query`过滤性更好的索引；
   - 在选择组合索引的时候，当前`query`中过滤性最好的字段在索引字段顺序中，位置越靠前越好；
   - 在选择组合索引的时候，尽量选择可以包含当前`query`中的`where`子句中更多字段的索引；
   - 尽可能通过分析统计信息和调整`query`的写法来达到选择何时索引的目的。

6. 下面给出测试用例：

   ```mysql
   mysql> create table wuyantest02(
       -> id int primary key not null auto_increment,
       -> c1 char(10),
       -> c2 char(10),
       -> c3 char(10),
       -> c4 char(10),
       -> c5 char(10),
       -> C6 char(10)
       -> );
   Query OK, 0 rows affected (0.04 sec)
   
   mysql> insert into wuyantest02(c1, c2, c3, c4, c5, c6) values('a1', 'a2', 'a3', 'a4', 'a5', 'a6');
   Query OK, 1 row affected (0.01 sec)
   
   mysql> insert into wuyantest02(c1, c2, c3, c4, c5, c6) values('b1', 'b2', 'b3', 'b4', 'b5', 'b6');
   Query OK, 1 row affected (0.00 sec)
   
   mysql> insert into wuyantest02(c1, c2, c3, c4, c5, c6) values('c1', 'c2', 'c3', 'c4', 'c5', 'c6');
   Query OK, 1 row affected (0.00 sec)
   
   mysql> insert into wuyantest02(c1, c2, c3, c4, c5, c6) values('d1', 'd2', 'd3', 'd4', 'd5', 'd6');
   Query OK, 1 row affected (0.01 sec)
   
   mysql> insert into wuyantest02(c1, c2, c3, c4, c5, c6) values('e1', 'e2', 'e3', 'e4', 'e5', 'e6');
   Query OK, 1 row affected (0.00 sec)
   
   mysql> select * from wuyantest02
       -> ;
   +----+------+------+------+------+------+------+
   | id | c1   | c2   | c3   | c4   | c5   | C6   |
   +----+------+------+------+------+------+------+
   |  1 | a1   | a2   | a3   | a4   | a5   | a6   |
   |  2 | b1   | b2   | b3   | b4   | b5   | b6   |
   |  3 | c1   | c2   | c3   | c4   | c5   | c6   |
   |  4 | d1   | d2   | d3   | d4   | d5   | d6   |
   |  5 | e1   | e2   | e3   | e4   | e5   | e6   |
   +----+------+------+------+------+------+------+
   5 rows in set (0.00 sec)
   
   mysql> show index from wuyantest02;
   +-------------+------------+-----------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
   | Table       | Non_unique | Key_name              | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
   +-------------+------------+-----------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
   | wuyantest02 |          0 | PRIMARY               |            1 | id          | A         |           4 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
   | wuyantest02 |          1 | idx_wuyantest02_c1234 |            1 | c1          | A         |           5 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
   | wuyantest02 |          1 | idx_wuyantest02_c1234 |            2 | c2          | A         |           5 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
   | wuyantest02 |          1 | idx_wuyantest02_c1234 |            3 | c3          | A         |           5 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
   | wuyantest02 |          1 | idx_wuyantest02_c1234 |            4 | c4          | A         |           5 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
   +-------------+------------+-----------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
   5 rows in set (0.02 sec)
   
   
   mysql> explain select * from wuyantest02 where c1 = 'a1';
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref   | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 41      | const |    1 |   100.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2';
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref         | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 82      | const,const |    1 |   100.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' and c3 = 'a3' and c4 = 'a4';
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------------------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref                     | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------------------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 164     | const,const,const,const |    1 |   100.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------------------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' and c4 = 'a4' and c3 = 'a3';
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------------------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref                     | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------------------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 164     | const,const,const,const |    1 |   100.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------------------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' and c3 > 'c3' and c4 = 'a4';
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type  | possible_keys         | key                   | key_len | ref  | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | range | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 123     | NULL |    1 |    20.00 | Using index condition |
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' and c4 > 'c4' and c3 = 'a3';
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type  | possible_keys         | key                   | key_len | ref  | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | range | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 164     | NULL |    1 |   100.00 | Using index condition |
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' and c4 = 'c4' order by c3;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref         | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 82      | const,const |    1 |    20.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' order by c3;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref         | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 82      | const,const |    1 |   100.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' order by c4;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+---------------------------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref         | rows | filtered | Extra                                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+---------------------------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 82      | const,const |    1 |   100.00 | Using index condition; Using filesort |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+---------------------------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c5 = 'a5' order by c2, c3;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+------------------------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref   | rows | filtered | Extra                              |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+------------------------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 41      | const |    1 |    20.00 | Using index condition; Using where |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+------------------------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c5 = 'a5' order by c3, c2;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+----------------------------------------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref   | rows | filtered | Extra                                              |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+----------------------------------------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 41      | const |    1 |    20.00 | Using index condition; Using where; Using filesort |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+----------------------------------------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' order by c2, c3;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref         | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 82      | const,const |    1 |   100.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' and c5 = 'a5' order by c2, c3;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+------------------------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref         | rows | filtered | Extra                              |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+------------------------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 82      | const,const |    1 |    20.00 | Using index condition; Using where |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+------------------------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 = 'a2' and c5 = 'a5' order by c3, c2;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+------------------------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref         | rows | filtered | Extra                              |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+------------------------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 82      | const,const |    1 |    20.00 | Using index condition; Using where |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------------+------+----------+------------------------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c5 = 'a5' order by c3, c2;
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+----------------------------------------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref   | rows | filtered | Extra                                              |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+----------------------------------------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 41      | const |    1 |    20.00 | Using index condition; Using where; Using filesort |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+----------------------------------------------------+
   1 row in set, 1 warning (0.00 sec)
   
mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 like '%kk' and c3 = 'a3';
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref   | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 41      | const |    1 |    20.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 like 'kk%' and c3 = 'a3';
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type  | possible_keys         | key                   | key_len | ref  | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | range | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 123     | NULL |    1 |    20.00 | Using index condition |
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 like '%kk%' and c3 = 'a3';
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type | possible_keys         | key                   | key_len | ref   | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | ref  | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 41      | const |    1 |    20.00 | Using index condition |
   +----+-------------+-------------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain select * from wuyantest02 where c1 = 'a1' and c2 like 'k%kk%' and c3 = 'a3';
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   | id | select_type | table       | partitions | type  | possible_keys         | key                   | key_len | ref  | rows | filtered | Extra                 |
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   |  1 | SIMPLE      | wuyantest02 | NULL       | range | idx_wuyantest02_c1234 | idx_wuyantest02_c1234 | 123     | NULL |    1 |    20.00 | Using index condition |
   +----+-------------+-------------+------------+-------+-----------------------+-----------------------+---------+------+------+----------+-----------------------+
   1 row in set, 1 warning (0.00 sec)
   ```
   
7. 口诀：

   - 全值匹配我最爱，最左前缀要遵守；
   - 带头大哥不能死，中间兄弟不能段；
   - 索引列上少计算，范围之后全失效；
   - LIKE百分写最后，覆盖索引不写星；
   - 不等空值还有or，索引失效要少用。

















































